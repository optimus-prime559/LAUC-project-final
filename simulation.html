<script>
let tempChart=null, timeChart=null;

function drawPipe(r1,r2,rq){
    const c=document.getElementById("pipeCanvas");
    const ctx=c.getContext("2d");
    ctx.clearRect(0,0,300,300);

    const cx=150, cy=150;
    const scale=110/r2;

    const R1=r1*scale;
    const R2=r2*scale;
    const RQ=rq*scale;

    // Gradient
    const grad=ctx.createRadialGradient(cx,cy,R1,cx,cy,R2);
    grad.addColorStop(0,"#ff5722");
    grad.addColorStop(1,"#ffffff");

    // Outer pipe
    ctx.beginPath();
    ctx.arc(cx,cy,R2,0,2*Math.PI);
    ctx.fillStyle=grad;
    ctx.fill();

    // Inner pipe
    ctx.beginPath();
    ctx.arc(cx,cy,R1,0,2*Math.PI);
    ctx.fillStyle="#fff";
    ctx.fill();

    ctx.strokeStyle="#000";
    ctx.lineWidth=2;
    ctx.stroke();

    // Radius lines
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R1,cy);
    ctx.moveTo(cx,cy);
    ctx.lineTo(cx+R2,cy);
    ctx.stroke();

    // Labels r1 and r2
    ctx.fillStyle="#000";
    ctx.font="14px Arial";
    ctx.fillText(`r₁ = ${r1.toFixed(3)} m`, cx+R1/2-25, cy-8);
    ctx.fillText(`r₂ = ${r2.toFixed(3)} m`, cx+R2/2-25, cy+18);

    // Selected radius (dashed)
    ctx.setLineDash([6,4]);
    ctx.beginPath();
    ctx.arc(cx,cy,RQ,0,2*Math.PI);
    ctx.strokeStyle="#0b5ed7";
    ctx.lineWidth=2;
    ctx.stroke();
    ctx.setLineDash([]);

    // Selected radius label
    ctx.fillStyle="#0b5ed7";
    ctx.fillText(
        `Selected r = ${rq.toFixed(3)} m`,
        cx - 55,
        cy - RQ - 10
    );
}

function calculate(){
    const r1=document.getElementById("r1").value*document.getElementById("r1unit").value;
    const r2=document.getElementById("r2").value*document.getElementById("r2unit").value;
    const rq=document.getElementById("rq").value*document.getElementById("rqunit").value;

    const T1=+document.getElementById("T1").value;
    const T2=+document.getElementById("T2").value;
    const k=+document.getElementById("k").value;
    const L=+document.getElementById("L").value;
    const time=+document.getElementById("time").value;
    const unit=document.getElementById("unit").value;

    if(rq<r1 || rq>r2){
        document.getElementById("results").innerHTML=
        "<b style='color:red'>Selected radius must lie between inner and outer radius</b>";
        return;
    }

    const Q=(2*Math.PI*k*L*(T1-T2))/Math.log(r2/r1);
    const Qout=(unit==="cal")?Q/4.186:Q;
    const Tr=T1+(T2-T1)*Math.log(rq/r1)/Math.log(r2/r1);
    const Rth=Math.log(r2/r1)/(2*Math.PI*k*L);

    document.getElementById("results").innerHTML=
        `<b>Heat Flow Rate:</b> ${Qout.toFixed(3)} ${unit==="cal"?"cal/sec":"W"}<br>
         <b>Total Heat Transferred:</b> ${(Qout*time).toFixed(2)}<br>
         <b>Thermal Resistance:</b> ${Rth.toFixed(6)} K/W<br>
         <b>Temperature at selected radius:</b> ${Tr.toFixed(2)} °C`;

    drawPipe(r1,r2,rq);

    /* ---------- TEMPERATURE GRAPH ---------- */
    const rArr=[],tArr=[];
    for(let i=0;i<=20;i++){
        const r=r1+(r2-r1)*i/20;
        rArr.push(r.toFixed(4));
        tArr.push(T1+(T2-T1)*Math.log(r/r1)/Math.log(r2/r1));
    }

    if(tempChart) tempChart.destroy();
    tempChart=new Chart(document.getElementById("tempChart"),{
        type:"line",
        data:{
            labels:rArr,
            datasets:[{
                label:"Temperature (°C)",
                data:tArr,
                borderColor:"#ff5722",
                borderWidth:3
            }]
        },
        options:{
            scales:{
                x:{ title:{display:true,text:"Radius (m)"} },
                y:{ title:{display:true,text:"Temperature (°C)"} }
            }
        }
    });

    /* ---------- HEAT FLOW GRAPH ---------- */
    const t=[],q=[];
    for(let i=0;i<=10;i++){
        t.push(i*time/10);
        q.push(Qout);
    }

    if(timeChart) timeChart.destroy();
    timeChart=new Chart(document.getElementById("timeChart"),{
        type:"line",
        data:{
            labels:t,
            datasets:[{
                label:"Heat Flow Rate",
                data:q,
                borderColor:"#0b5ed7",
                borderWidth:3
            }]
        },
        options:{
            scales:{
                x:{ title:{display:true,text:"Time (seconds)"} },
                y:{ title:{display:true,text:`Heat Flow (${unit==="cal"?"cal/sec":"W"})`} }
            }
        }
    });
}

calculate();
</script>
